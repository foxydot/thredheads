// version 1.6.0
// http://welcome.totheinter.net/columnizer-jquery-plugin/
// created by: Adam Wulf @adamwulf, adam.wulf@gmail.com
(function(e){e.fn.columnize=function(t){var n={width:400,columns:!1,buildOnce:!1,overflow:!1,doneFunc:function(){},target:!1,ignoreImageLoading:!0,columnFloat:"left",lastNeverTallest:!1,accuracy:!1,manualBreaks:!1,cssClassPrefix:""},t=e.extend(n,t);if(typeof t.width=="string"){t.width=parseInt(t.width);isNaN(t.width)&&(t.width=n.width)}return this.each(function(){function h(e,t){var n=t?".":"";return f.length?n+f+"-"+e:n+e}function p(n,r,i,s){while((a||i.height()<s)&&r[0].childNodes.length){var o=r[0].childNodes[0];if(e(o).find(h("columnbreak",!0)).length)return;if(e(o).hasClass(h("columnbreak")))return;n.append(o)}if(n[0].childNodes.length==0)return;var u=n[0].childNodes,f=u[u.length-1];n[0].removeChild(f);var l=e(f);if(l[0].nodeType==3){var c=l[0].nodeValue,p=t.width/18;t.accuracy&&(p=t.accuracy);var d,v=null;while(i.height()<s&&c.length){var m=c.indexOf(" ",p);m!=-1?d=c.substring(0,c.indexOf(" ",p)):d=c;v=document.createTextNode(d);n.append(v);c.length>p&&m!=-1?c=c.substring(m):c=""}if(i.height()>=s&&v!=null){n[0].removeChild(v);c=v.nodeValue+c}if(!c.length)return!1;l[0].nodeValue=c}r.contents().length?r.prepend(l):r.append(l);return l[0].nodeType==3}function d(e,t,n,r){if(e.contents(":last").find(h("columnbreak",!0)).length)return;if(e.contents(":last").hasClass(h("columnbreak")))return;if(t.contents().length){var i=t.contents(":first");if(i.get(0).nodeType!=1)return;var s=i.clone(!0);if(i.hasClass(h("columnbreak"))){e.append(s);i.remove()}else if(a){e.append(s);i.remove()}else if(s.get(0).nodeType==1&&!s.hasClass(h("dontend"))){e.append(s);if(s.is("img")&&n.height()<r+20)i.remove();else if(!i.hasClass(h("dontsplit"))&&n.height()<r+20)i.remove();else if(s.is("img")||i.hasClass(h("dontsplit")))s.remove();else{s.empty();if(!p(s,i,n,r)){i.addClass(h("split"));i.children().length&&d(s,i,n,r)}else i.addClass(h("split"));s.get(0).childNodes.length==0&&s.remove()}}}}function v(){if(r.data("columnized")&&r.children().length==1)return;r.data("columnized",!0);r.data("columnizing",!0);r.empty();r.append(e("<div class='"+h("first")+" "+h("last")+" "+h("column")+" "+"' style='width:100%; float: "+t.columnFloat+";'></div>"));$col=r.children().eq(r.children().length-1);$destroyable=s.clone(!0);if(t.overflow){targetHeight=t.overflow.height;p($col,$destroyable,$col,targetHeight);$destroyable.contents().find(":first-child").hasClass(h("dontend"))||d($col,$destroyable,$col,targetHeight);while($col.contents(":last").length&&m($col.contents(":last").get(0))){var n=$col.contents(":last");n.remove();$destroyable.prepend(n)}var i="",o=document.createElement("DIV");while($destroyable[0].childNodes.length>0){var u=$destroyable[0].childNodes[0];if(u.attributes)for(var a=0;a<u.attributes.length;a++)u.attributes[a].nodeName.indexOf("jQuery")==0&&u.removeAttribute(u.attributes[a].nodeName);o.innerHTML="";o.appendChild($destroyable[0].childNodes[0]);i+=o.innerHTML}var f=e(t.overflow.id)[0];f.innerHTML=i}else $col.append($destroyable);r.data("columnizing",!1);t.overflow&&t.overflow.doneFunc&&t.overflow.doneFunc()}function m(t){if(t.nodeType==3)return/^\s+$/.test(t.nodeValue)?t.previousSibling?m(t.previousSibling):!1:!1;return t.nodeType!=1?!1:e(t).hasClass(h("dontend"))?!0:t.childNodes.length==0?!1:m(t.childNodes[t.childNodes.length-1])}function g(){l=0;if(o==r.width())return;o=r.width();var n=Math.round(r.width()/t.width),u=t.width,f=t.height;t.columns&&(n=t.columns);if(a){n=s.find(h("columnbreak",!0)).length+1;u=!1}if(n<=1)return v();if(r.data("columnizing"))return;r.data("columnized",!0);r.data("columnizing",!0);r.empty();r.append(e("<div style='width:"+Math.floor(100/n)+"%; float: "+t.columnFloat+";'></div>"));N=r.children(":last");N.append(s.clone());i=N.height();r.empty();var c=i/n,g=!0,y=3,b=!1;if(t.overflow){y=1;c=t.overflow.height}else if(f&&u){y=1;c=f;b=!0}for(var w=0;w<y&&y<20;w++){r.empty();var E;try{E=s.clone(!0)}catch(S){E=s.clone()}E.css("visibility","hidden");for(var x=0;x<n;x++){var T=x==0?h("first"):"";T+=" "+h("column");var T=x==n-1?h("last")+" "+T:T;r.append(e("<div class='"+T+"' style='width:"+Math.floor(100/n)+"%; float: "+t.columnFloat+";'></div>"))}var x=0;while(x<n-(t.overflow?0:1)||b&&E.contents().length){r.children().length<=x&&r.append(e("<div class='"+T+"' style='width:"+Math.floor(100/n)+"%; float: "+t.columnFloat+";'></div>"));var N=r.children().eq(x);p(N,E,N,c);d(N,E,N,c);while(N.contents(":last").length&&m(N.contents(":last").get(0))){var C=N.contents(":last");C.remove();E.prepend(C)}x++;N.contents().length==0&&E.contents().length?N.append(E.contents(":first")):x==n-(t.overflow?0:1)&&!t.overflow&&E.find(h("columnbreak",!0)).length&&n++}if(t.overflow&&!b){var k=!1,L=document.all&&navigator.appVersion.indexOf("MSIE 7.")!=-1;if(k||L){var A="",O=document.createElement("DIV");while(E[0].childNodes.length>0){var M=E[0].childNodes[0];for(var x=0;x<M.attributes.length;x++)M.attributes[x].nodeName.indexOf("jQuery")==0&&M.removeAttribute(M.attributes[x].nodeName);O.innerHTML="";O.appendChild(E[0].childNodes[0]);A+=O.innerHTML}var _=e(t.overflow.id)[0];_.innerHTML=A}else e(t.overflow.id).empty().append(E.contents().clone(!0))}else if(!b){N=r.children().eq(r.children().length-1);while(E.contents().length)N.append(E.contents(":first"));var D=N.height(),P=D-c,H=0,B=1e7,j=0,F=!1,I=0;r.children().each(function(e){return function(t){var n=e.children().eq(t),r=n.children(":last").find(h("columnbreak",!0)).length;if(!r){var i=n.height();F=!1;H+=i;if(i>j){j=i;F=!0}i<B&&(B=i);I++}}}(r));var q=H/I;if(H==0)w=y;else if(t.lastNeverTallest&&F){l+=30;c+=30;w==y-1&&y++}else j-B>30?c=q+30:Math.abs(q-c)>20?c=q:w=y}else{r.children().each(function(e){N=r.children().eq(e);N.width(u+"px");if(e==0)N.addClass(h("first"));else if(e==r.children().length-1)N.addClass(h("last"));else{N.removeClass(h("first"));N.removeClass(h("last"))}});r.width(r.children().length*u+"px")}r.append(e("<br style='clear:both;'>"))}r.find(h("column",!0)).find(":first"+h("removeiffirst",!0)).remove();r.find(h("column",!0)).find(":last"+h("removeiflast",!0)).remove();r.data("columnizing",!1);t.overflow&&t.overflow.doneFunc();t.doneFunc()}var r=t.target?e(t.target):e(this),i=e(this).height(),s=e("<div></div>"),o=0,u=!1,a=t.manualBreaks,f=n.cssClassPrefix;typeof t.cssClassPrefix=="string"&&(f=t.cssClassPrefix);var l=0;s.append(e(this).contents().clone(!0));if(!t.ignoreImageLoading&&!t.target&&!r.data("imageLoaded")){r.data("imageLoaded",!0);if(e(this).find("img").length>0){var c=function(e,n){return function(){if(!e.data("firstImageLoaded")){e.data("firstImageLoaded","true");e.empty().append(n.children().clone(!0));e.columnize(t)}}}(e(this),s);e(this).find("img").one("load",c);e(this).find("img").one("abort",c);return}}r.empty();g();t.buildOnce||e(window).resize(function(){if(!t.buildOnce&&e.browser.msie){r.data("timeout")&&clearTimeout(r.data("timeout"));r.data("timeout",setTimeout(g,200))}else t.buildOnce||g()})})}})(jQuery);